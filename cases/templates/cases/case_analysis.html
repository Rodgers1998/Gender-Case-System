{% extends 'base.html' %}

{% block title %}Case Analysis{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Case Analysis</h2>
    <div class="mb-4">
        <label for="county-select">Select County:</label>
        <select id="county-select" class="form-control">
            <option value="">All Counties</option>
            {% for county in county_data %}
                <option value="{{ county.county }}">{{ county.county }} ({{ county.total }} cases)</option>
            {% endfor %}
        </select>
    </div>

    <canvas id="county-chart" width="400" height="200"></canvas>
    <canvas id="subcounty-chart" width="400" height="200" style="display:none;"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var countyData = {
        labels: [{% for county in county_data %}"{{ county.county }}", {% endfor %}],
        datasets: [{
            label: 'Number of Cases',
            data: [{% for county in county_data %}{{ county.total }}, {% endfor %}],
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    };

    var ctx = document.getElementById('county-chart').getContext('2d');
    var countyChart = new Chart(ctx, {
        type: 'bar',
        data: countyData,
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Subcounty chart generation
    document.getElementById('county-select').addEventListener('change', function() {
        var selectedCounty = this.value;
        var subCountyData = {
            labels: [],
            datasets: [{
                label: 'Cases by Type',
                data: [],
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        };

        {% for subcounty in subcounty_data %}
            if ("{{ subcounty.county }}" === selectedCounty) {
                subCountyData.labels.push("{{ subcounty.sub_county }} ({{ subcounty.case_type }})");
                subCountyData.datasets[0].data.push({{ subcounty.total }});
            }
        {% endfor %}

        if (subCountyData.labels.length > 0) {
            var ctxSubcounty = document.getElementById('subcounty-chart').getContext('2d');
            document.getElementById('subcounty-chart').style.display = 'block';
            
            new Chart(ctxSubcounty, {
                type: 'bar',
                data: subCountyData,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        } else {
            document.getElementById('subcounty-chart').style.display = 'none';
        }
    });
</script>
{% endblock %}
